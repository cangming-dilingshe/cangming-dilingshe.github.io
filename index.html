<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§¯åˆ†å•†åŸ</title>
  <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 750px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      padding-bottom: 60px;
    }
    
    /* ç™»å½•é¡µé¢æ ·å¼ */
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    }
    
    .login-box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    
    .login-title {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #2575fc;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #1a68e8;
    }
    
    .error-message {
      color: #e74c3c;
      margin-top: 10px;
      text-align: center;
    }
    
    /* ä¸»åº”ç”¨æ ·å¼ */
    .app-container {
      display: none;
    }
    
    /* é¦–é¡µç‰¹æ®Šæ ·å¼ - æ— é¡¶éƒ¨è“æ¡ */
    .home-header {
      display: none;
    }
    
    .content {
      padding: 0;
      min-height: calc(100vh - 60px);
    }
    
    /* åº•éƒ¨å¯¼èˆª */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      max-width: 750px;
      margin: 0 auto;
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      color: #666;
      cursor: pointer;
    }
    
    .nav-item.active {
      color: #2575fc;
    }
    
    .nav-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    
    /* é¦–é¡µæ ·å¼ */
    .home-container {
      text-align: center;
      padding: 0;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.3)), 
                  url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2070&q=80') center/cover no-repeat;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
    }
    
    .home-title {
      font-size: 28px;
      margin-bottom: 30px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .home-content {
      margin-top: 40px;
      font-size: 18px;
      line-height: 1.8;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }
    
    .home-link {
      color: #ffd700;
      text-decoration: none;
      font-weight: bold;
      padding: 10px 20px;
      border: 2px solid #ffd700;
      border-radius: 25px;
      margin-top: 20px;
      display: inline-block;
      transition: all 0.3s ease;
    }
    
    .home-link:hover {
      background: #ffd700;
      color: #333;
    }
    
    /* å•†åŸæ ·å¼ */
    .shop-header {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 15px;
      text-align: center;
    }
    
    .category-tabs {
      display: flex;
      overflow-x: auto;
      padding: 10px 0;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      background: white;
    }
    
    .category-tab {
      padding: 8px 15px;
      white-space: nowrap;
      cursor: pointer;
      border-radius: 20px;
      margin-right: 10px;
    }
    
    .category-tab.active {
      background: #2575fc;
      color: white;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 15px;
      padding-bottom: 80px;
    }
    
    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-image {
      width: 100%;
      height: 120px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    
    .product-info {
      padding: 10px;
    }
    
    .product-name {
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .product-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
      height: 32px;
      overflow: hidden;
    }
    
    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .product-points {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .exchange-btn {
      background: #2575fc;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    
    /* ä¸ªäººä¸­å¿ƒæ ·å¼ */
    .profile-header {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 30px 20px 20px;
      text-align: center;
    }
    
    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 24px;
    }
    
    .user-name {
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .user-points {
      font-size: 14px;
    }
    
    .profile-section {
      margin: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
      font-weight: 500;
    }
    
    .section-content {
      padding: 15px;
    }
    
    .address-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .address-item:last-child {
      border-bottom: none;
    }
    
    .address-name {
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .address-detail {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .edit-address-btn {
      color: #2575fc;
      cursor: pointer;
      text-align: right;
      margin-top: 10px;
    }
    
    .item-list {
      list-style: none;
    }
    
    .item-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      color: #666;
    }
    
    .item-list li:last-child {
      border-bottom: none;
    }
    
    .section-subtitle {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 10px;
      margin-top: 15px;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
    }
    
    .modal-title {
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .btn-cancel {
      background: #95a5a6;
      margin-right: 10px;
    }
    
    .btn-confirm {
      background: #e74c3c;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h2 class="login-title">ç§¯åˆ†å•†åŸ</h2>
      <div class="form-group">
        <label for="username">è´¦å·</label>
        <input type="text" id="username" class="form-control" placeholder="è¯·è¾“å…¥è´¦å·">
      </div>
      <div class="form-group">
        <label for="password">å¯†ç </label>
        <input type="password" id="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
      </div>
      <button id="loginBtn" class="btn">
        <span id="loginText">ç™»å½•</span>
        <span id="loginLoading" class="loading" style="display: none;"></span>
      </button>
      <div id="loginError" class="error-message"></div>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ -->
  <div id="app" class="app-container">
    <!-- é¦–é¡µæ— é¡¶éƒ¨è“æ¡ -->
    <div id="homeHeader" class="home-header">
      <h1 id="pageTitle">é¦–é¡µ</h1>
    </div>

    <!-- å•†åŸå’Œä¸ªäººä¸­å¿ƒæœ‰é¡¶éƒ¨è“æ¡ -->
    <div id="shopHeader" class="shop-header" style="display: none;">
      <h1>ç§¯åˆ†å•†åŸ</h1>
    </div>

    <div id="profileHeader" class="profile-header" style="display: none;">
      <h1>ä¸ªäººä¸­å¿ƒ</h1>
    </div>

    <div class="content">
      <!-- é¦–é¡µ -->
      <div id="homePage" class="page">
        <div class="home-container">
          <h2 class="home-title">æ¬¢è¿æ¥åˆ°ç§¯åˆ†å…‘æ¢å•†åŸ</h2>
          <div class="home-content">
            <p>ä½¿ç”¨ç§¯åˆ†å…‘æ¢ç²¾ç¾å•†å“</p>
            <p>å¤šç§å•†å“ç­‰ä½ æ¥å…‘æ¢</p>
            <a href="https://www.douyin.com" target="_blank" class="home-link">
              äº†è§£æ›´å¤š
            </a>
          </div>
        </div>
      </div>

      <!-- å•†åŸ -->
      <div id="shopPage" class="page" style="display: none;">
        <div class="category-tabs">
          <div class="category-tab active" data-category="å…¨éƒ¨">å…¨éƒ¨</div>
          <div class="category-tab" data-category="ä¼šå‘˜ç¤¼">ä¼šå‘˜ç¤¼</div>
          <div class="category-tab" data-category="12æ˜Ÿåº§">12æ˜Ÿåº§</div>
          <div class="category-tab" data-category="æ˜Ÿå®ˆç¤¼">æ˜Ÿå®ˆç¤¼</div>
          <div class="category-tab" data-category="é›¶é£Ÿç¤¼ç›’">é›¶é£Ÿç¤¼ç›’</div>
        </div>

        <div id="productsContainer" class="products-grid">
          <!-- å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
      </div>

      <!-- ä¸ªäººä¸­å¿ƒ -->
      <div id="profilePage" class="page" style="display: none;">
        <div class="profile-header">
          <div class="user-avatar">ğŸ‘¤</div>
          <div class="user-name" id="profileUserName">ç”¨æˆ·</div>
          <div class="user-points" id="profilePoints">0ç§¯åˆ†</div>
        </div>

        <div class="profile-section">
          <div class="section-title">æ”¶è´§åœ°å€</div>
          <div class="section-content">
            <div class="address-item">
              <div class="address-name" id="userAddressName">ç”¨æˆ·</div>
              <div class="address-detail" id="userAddress">è¯·è®¾ç½®æ”¶è´§åœ°å€</div>
              <div class="edit-address-btn" id="editAddressBtn">ç¼–è¾‘</div>
            </div>
          </div>
        </div>

        <div class="profile-section">
          <div class="section-title">æˆ‘çš„å…‘æ¢</div>
          <div class="section-content">
            <div class="section-subtitle">å·²å…‘æ¢æœªå‘è´§</div>
            <ul class="item-list" id="pendingItemsList">
              <li style="color: #999;">æš‚æ— å¾…å‘è´§å•†å“</li>
            </ul>

            <div class="section-subtitle">å·²å‘è´§</div>
            <ul class="item-list" id="shippedItemsList">
              <li style="color: #999;">æš‚æ— å·²å‘è´§å•†å“</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <div class="nav-item active" data-page="homePage">
        <div class="nav-icon">ğŸ </div>
        <div>é¦–é¡µ</div>
      </div>
      <div class="nav-item" data-page="shopPage">
        <div class="nav-icon">ğŸ›’</div>
        <div>å•†åŸ</div>
      </div>
      <div class="nav-item" data-page="profilePage">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>æˆ‘çš„</div>
      </div>
    </div>
  </div>

  <!-- å…‘æ¢ç¡®è®¤æ¨¡æ€æ¡† -->
  <div id="exchangeModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">ç¡®è®¤å…‘æ¢</h3>
      <p>æ‚¨ç¡®å®šè¦å…‘æ¢ <span id="confirmProductName"></span> å—ï¼Ÿ</p>
      <p>éœ€è¦æ¶ˆè€— <span id="confirmProductPoints"></span> ç§¯åˆ†</p>
      <div class="modal-actions">
        <button id="cancelExchange" class="btn btn-cancel">å–æ¶ˆ</button>
        <button id="confirmExchange" class="btn btn-confirm">ç¡®è®¤å…‘æ¢</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘åœ°å€æ¨¡æ€æ¡† -->
  <div id="addressModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">ç¼–è¾‘åœ°å€</h3>
      <div class="form-group">
        <label for="editName">æ”¶è´§äºº</label>
        <input type="text" id="editName" class="form-control">
      </div>
      <div class="form-group">
        <label for="editAddress">è¯¦ç»†åœ°å€</label>
        <textarea id="editAddress" class="form-control" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button id="cancelAddress" class="btn btn-cancel">å–æ¶ˆ</button>
        <button id="saveAddress" class="btn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let currentUser = null;
    let currentProductId = null;

    // ğŸ”§ æ›¿æ¢ä¸ºæ‚¨çš„Supabaseé…ç½®
    const SUPABASE_CONFIG = {
      url: 'https://qesatalyodwvqgraxitx.supabase.co',
      key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlc2F0YWx5b2R3dnFncmF4aXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzIyNzMsImV4cCI6MjA3ODI0ODI3M30.muPrn83VJP1XsInGnYEnLcO2e3c7C-RVXH8KUbc9fQc'
    };

    // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
    const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

    // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
    async function debugDatabase() {
      try {
        console.log('=== æ•°æ®åº“è°ƒè¯•ä¿¡æ¯ ===');
        
        // æ£€æŸ¥ç”¨æˆ·è¡¨
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('*')
          .limit(5);
        
        if (usersError) {
          console.error('ç”¨æˆ·è¡¨æŸ¥è¯¢é”™è¯¯:', usersError);
        } else {
          console.log('ç”¨æˆ·è¡¨ç»“æ„:', users);
          if (users && users.length > 0) {
            console.log('ç”¨æˆ·è¡¨å­—æ®µ:', Object.keys(users[0]));
          }
        }

      } catch (error) {
        console.error('æ•°æ®åº“è°ƒè¯•é”™è¯¯:', error);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è°ƒè¯•
    document.addEventListener('DOMContentLoaded', function() {
      debugDatabase();
    });

    // è°ƒç”¨APIçš„é€šç”¨å‡½æ•°
    async function callAppsScript(action, parameters = {}) {
      try {
        switch (action) {
          case 'login':
            return await handleLogin(parameters.username, parameters.password);
          case 'getProducts':
            return await getProducts(parameters.category);
          case 'updateAddress':
            return await updateAddress(parameters.username, parameters.address);
          case 'exchangeProduct':
            return await exchangeProduct(parameters.username, parameters.productId);
          case 'getUserInfo':
            return await getUserInfo(parameters.username);
          default:
            throw new Error('æœªçŸ¥æ“ä½œ');
        }
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        throw error;
      }
    }

    // ç™»å½•å¤„ç† - ç›´æ¥ä»usersè¡¨çš„æ•°ç»„å­—æ®µè¯»å–
    async function handleLogin(username, password) {
      try {
        console.log('ç™»å½•å°è¯•:', username);
        
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .eq('username', username)
          .eq('password', password);

        if (error) {
          console.error('ç™»å½•æŸ¥è¯¢é”™è¯¯:', error);
          throw error;
        }

        console.log('æŸ¥è¯¢åˆ°çš„ç”¨æˆ·:', users);

        if (users && users.length > 0) {
          const user = users[0];
          console.log('æ‰¾åˆ°ç”¨æˆ·:', user);
          
          // ç›´æ¥ä»usersè¡¨çš„æ•°ç»„å­—æ®µè¯»å–å…‘æ¢è®°å½•
          // ç¡®ä¿pending_itemså’Œshipped_itemsæ˜¯æ•°ç»„
          user.pendingItems = Array.isArray(user.pending_items) ? user.pending_items : [];
          user.shippedItems = Array.isArray(user.shipped_items) ? user.shipped_items : [];

          console.log('å¾…å‘è´§å•†å“:', user.pendingItems);
          console.log('å·²å‘è´§å•†å“:', user.shippedItems);

          // ä¸è¿”å›å¯†ç 
          const { password: _, pending_items, shipped_items, ...userInfo } = user;
          userInfo.pendingItems = user.pendingItems;
          userInfo.shippedItems = user.shippedItems;
          
          return {
            success: true,
            user: userInfo
          };
        } else {
          console.log('æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·');
          return { success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' };
        }
      } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        return { success: false, message: 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥: ' + error.message };
      }
    }

    // è·å–å•†å“
    async function getProducts(category) {
      try {
        let query = supabase.from('products').select('*');
        
        if (category && category !== 'å…¨éƒ¨') {
          query = query.eq('category', category);
        }

        const { data: products, error } = await query;

        if (error) {
          console.error('è·å–å•†å“é”™è¯¯:', error);
          throw error;
        }
        
        console.log('è·å–åˆ°çš„å•†å“:', products);
        return products || [];
      } catch (error) {
        console.error('è·å–å•†å“é”™è¯¯:', error);
        return [];
      }
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯ - ç›´æ¥ä»usersè¡¨çš„æ•°ç»„å­—æ®µè¯»å–
    async function getUserInfo(username) {
      try {
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .eq('username', username);

        if (error) throw error;

        if (users && users.length > 0) {
          const user = users[0];
          
          // ç›´æ¥ä»usersè¡¨çš„æ•°ç»„å­—æ®µè¯»å–å…‘æ¢è®°å½•
          user.pendingItems = Array.isArray(user.pending_items) ? user.pending_items : [];
          user.shippedItems = Array.isArray(user.shipped_items) ? user.shipped_items : [];

          // ä¸è¿”å›å¯†ç å’ŒåŸå§‹æ•°ç»„å­—æ®µ
          const { password: _, pending_items, shipped_items, ...userInfo } = user;
          userInfo.pendingItems = user.pendingItems;
          userInfo.shippedItems = user.shippedItems;
          
          return userInfo;
        }
        
        return null;
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
        return null;
      }
    }

    // æ›´æ–°åœ°å€
    async function updateAddress(username, address) {
      try {
        const { data, error } = await supabase
          .from('users')
          .update({ address })
          .eq('username', username);

        if (error) throw error;

        // åŒæ—¶æ›´æ–°å½“å‰ç”¨æˆ·çš„æ˜¾ç¤º
        if (currentUser && currentUser.username === username) {
          currentUser.address = address;
          updateUserInfo();
        }

        return { success: true };
      } catch (error) {
        console.error('æ›´æ–°åœ°å€é”™è¯¯:', error);
        return { success: false, message: 'åœ°å€ä¿å­˜å¤±è´¥: ' + error.message };
      }
    }

    // å…‘æ¢å•†å“ - ä¿®å¤ç‰ˆæœ¬ï¼Œç›´æ¥æ›´æ–°usersè¡¨çš„æ•°ç»„å­—æ®µ
    async function exchangeProduct(username, productId) {
      try {
        console.log('å¼€å§‹å…‘æ¢:', username, 'å•†å“ID:', productId);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const { data: users, error: userError } = await supabase
          .from('users')
          .select('*')
          .eq('username', username);

        if (userError) throw userError;
        if (!users || users.length === 0) {
          return { success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
        }

        const user = users[0];
        console.log('ç”¨æˆ·ä¿¡æ¯:', user);

        // è·å–å•†å“ä¿¡æ¯
        const { data: products, error: productError } = await supabase
          .from('products')
          .select('*')
          .eq('id', productId);

        if (productError) throw productError;
        if (!products || products.length === 0) {
          return { success: false, message: 'å•†å“ä¸å­˜åœ¨' };
        }

        const product = products[0];
        console.log('å•†å“ä¿¡æ¯:', product);

        // æ£€æŸ¥ç§¯åˆ†
        if (user.points < product.points) {
          return { success: false, message: 'ç§¯åˆ†ä¸è¶³' };
        }

        // è®¡ç®—æ–°ç§¯åˆ†
        const newPoints = user.points - product.points;

        // æ›´æ–°pending_itemsæ•°ç»„ - å°†æ–°å…‘æ¢çš„å•†å“æ·»åŠ åˆ°æ•°ç»„ä¸­
        const currentPendingItems = Array.isArray(user.pending_items) ? user.pending_items : [];
        const updatedPendingItems = [...currentPendingItems, product.name];

        console.log('æ›´æ–°å‰çš„pending_items:', currentPendingItems);
        console.log('æ›´æ–°åçš„pending_items:', updatedPendingItems);

        // æ›´æ–°ç”¨æˆ·æ•°æ®ï¼šç§¯åˆ†å’Œpending_items
        const { error: updateError } = await supabase
          .from('users')
          .update({ 
            points: newPoints,
            pending_items: updatedPendingItems
          })
          .eq('id', user.id);

        if (updateError) throw updateError;

        console.log('å…‘æ¢æˆåŠŸï¼Œæ–°ç§¯åˆ†:', newPoints, 'æ–°pending_items:', updatedPendingItems);

        // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
        if (currentUser && currentUser.username === username) {
          currentUser.points = newPoints;
          currentUser.pendingItems = updatedPendingItems;
          updateUserInfo();
        }

        return {
          success: true,
          newPoints: newPoints,
          productName: product.name
        };

      } catch (error) {
        console.error('å…‘æ¢é”™è¯¯:', error);
        return { success: false, message: 'å…‘æ¢å¤±è´¥: ' + error.message };
      }
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
    function updateUserInfo() {
      if (!currentUser) return;

      console.log('æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º:', currentUser);

      document.getElementById('profileUserName').textContent = currentUser.username;
      document.getElementById('profilePoints').textContent = currentUser.points + 'ç§¯åˆ†';
      document.getElementById('userAddressName').textContent = currentUser.username;
      document.getElementById('userAddress').textContent = currentUser.address || 'è¯·è®¾ç½®æ”¶è´§åœ°å€';

      // æ›´æ–°å¾…å‘è´§å’Œå·²å‘è´§å•†å“åˆ—è¡¨
      const pendingList = document.getElementById('pendingItemsList');
      const shippedList = document.getElementById('shippedItemsList');

      pendingList.innerHTML = '';
      shippedList.innerHTML = '';

      console.log('å¾…å‘è´§å•†å“:', currentUser.pendingItems);
      console.log('å·²å‘è´§å•†å“:', currentUser.shippedItems);

      // æ˜¾ç¤ºå¾…å‘è´§å•†å“
      if (currentUser.pendingItems && currentUser.pendingItems.length > 0) {
        currentUser.pendingItems.forEach(item => {
          if (item && item.trim()) {
            const li = document.createElement('li');
            li.textContent = item;
            li.style.color = '#333';
            pendingList.appendChild(li);
          }
        });
      } else {
        pendingList.innerHTML = '<li style="color: #999;">æš‚æ— å¾…å‘è´§å•†å“</li>';
      }

      // æ˜¾ç¤ºå·²å‘è´§å•†å“
      if (currentUser.shippedItems && currentUser.shippedItems.length > 0) {
        currentUser.shippedItems.forEach(item => {
          if (item && item.trim()) {
            const li = document.createElement('li');
            li.textContent = item;
            li.style.color = '#333';
            shippedList.appendChild(li);
          }
        });
      } else {
        shippedList.innerHTML = '<li style="color: #999;">æš‚æ— å·²å‘è´§å•†å“</li>';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // åŸæœ‰çš„DOMäº‹ä»¶ç›‘å¬å™¨ä¿æŒä¸å˜
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
          switchPage(this.getAttribute('data-page'));
        });
      });

      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.category-tab').forEach(t => {
            t.classList.remove('active');
          });
          this.classList.add('active');
          loadProducts(this.getAttribute('data-category'));
        });
      });

      document.getElementById('cancelExchange').addEventListener('click', function() {
        document.getElementById('exchangeModal').style.display = 'none';
      });

      document.getElementById('confirmExchange').addEventListener('click', confirmExchange);

      document.getElementById('editAddressBtn').addEventListener('click', function() {
        document.getElementById('editName').value = document.getElementById('userAddressName').textContent;
        document.getElementById('editAddress').value = document.getElementById('userAddress').textContent;
        document.getElementById('addressModal').style.display = 'flex';
      });

      document.getElementById('cancelAddress').addEventListener('click', function() {
        document.getElementById('addressModal').style.display = 'none';
      });

      document.getElementById('saveAddress').addEventListener('click', saveAddress);
    });

    // ç™»å½•å‡½æ•°
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      const loginBtn = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const loginLoading = document.getElementById('loginLoading');

      if (!username || !password) {
        errorDiv.textContent = 'è¯·è¾“å…¥è´¦å·å’Œå¯†ç ';
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loginText.style.display = 'none';
      loginLoading.style.display = 'inline-block';
      loginBtn.disabled = true;
      errorDiv.textContent = '';

      try {
        const result = await callAppsScript('login', {
          username: username,
          password: password
        });

        if (result.success) {
          currentUser = result.user;
          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          updateUserInfo();
          loadProducts('å…¨éƒ¨');
          errorDiv.textContent = '';
        } else {
          errorDiv.textContent = result.message || 'ç™»å½•å¤±è´¥';
        }
      } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        errorDiv.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        loginText.style.display = 'inline-block';
        loginLoading.style.display = 'none';
        loginBtn.disabled = false;
      }
    }

    // åˆ‡æ¢é¡µé¢å‡½æ•°
    function switchPage(pageId) {
      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
      });

      // æ˜¾ç¤ºç›®æ ‡é¡µé¢
      document.getElementById(pageId).style.display = 'block';

      // æ›´æ–°é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤º
      document.getElementById('homeHeader').style.display = 'none';
      document.getElementById('shopHeader').style.display = 'none';
      document.getElementById('profileHeader').style.display = 'none';

      if (pageId === 'homePage') {
        // é¦–é¡µæ— é¡¶éƒ¨è“æ¡
      } else if (pageId === 'shopPage') {
        document.getElementById('shopHeader').style.display = 'block';
      } else if (pageId === 'profilePage') {
        document.getElementById('profileHeader').style.display = 'block';
      }

      // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) {
          item.classList.add('active');
        }
      });
    }

    // åŠ è½½å•†å“
    async function loadProducts(category) {
      try {
        const products = await callAppsScript('getProducts', {
          category: category
        });

        const container = document.getElementById('productsContainer');
        container.innerHTML = '';

        if (products && products.length > 0) {
          products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
              <div class="product-image">å•†å“å›¾ç‰‡</div>
              <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-description">${product.description}</div>
                <div class="product-footer">
                  <div class="product-points">${product.points}ç§¯åˆ†</div>
                  <button class="exchange-btn" data-id="${product.id}" data-name="${product.name}" data-points="${product.points}">ç«‹å³å…‘æ¢</button>
                </div>
              </div>
            `;
            container.appendChild(productCard);
          });

          // ä¸ºå…‘æ¢æŒ‰é’®æ·»åŠ äº‹ä»¶
          document.querySelectorAll('.exchange-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const productId = this.getAttribute('data-id');
              const productName = this.getAttribute('data-name');
              const productPoints = this.getAttribute('data-points');

              document.getElementById('confirmProductName').textContent = productName;
              document.getElementById('confirmProductPoints').textContent = productPoints;
              document.getElementById('exchangeModal').style.display = 'flex';
              currentProductId = productId;
            });
          });
        } else {
          container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">æš‚æ— å•†å“</div>';
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“å¤±è´¥:', error);
        const container = document.getElementById('productsContainer');
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #e74c3c;">åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      }
    }

    // ç¡®è®¤å…‘æ¢
    async function confirmExchange() {
      if (!currentUser || !currentProductId) return;

      try {
        const result = await callAppsScript('exchangeProduct', {
          username: currentUser.username,
          productId: currentProductId
        });

        document.getElementById('exchangeModal').style.display = 'none';

        if (result.success) {
          alert('å…‘æ¢æˆåŠŸï¼');
          // é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
          const updatedUserInfo = await callAppsScript('getUserInfo', {
            username: currentUser.username
          });
          if (updatedUserInfo) {
            currentUser = updatedUserInfo;
          }
          updateUserInfo();
        } else {
          alert('å…‘æ¢å¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('å…‘æ¢é”™è¯¯:', error);
        alert('å…‘æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // ä¿å­˜åœ°å€
    async function saveAddress() {
      if (!currentUser) return;

      const name = document.getElementById('editName').value;
      const address = document.getElementById('editAddress').value;

      if (!name || !address) {
        alert('è¯·å¡«å†™å®Œæ•´çš„åœ°å€ä¿¡æ¯');
        return;
      }

      try {
        const result = await callAppsScript('updateAddress', {
          username: currentUser.username,
          address: address
        });

        if (result.success) {
          document.getElementById('addressModal').style.display = 'none';
          currentUser.address = address;
          document.getElementById('userAddressName').textContent = name;
          document.getElementById('userAddress').textContent = address;
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('ä¿å­˜åœ°å€é”™è¯¯:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
  </script>
</body>
</html>
